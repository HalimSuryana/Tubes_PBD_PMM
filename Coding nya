USE HotelReservasi;
GO

-- 1. Total tamu
CREATE VIEW ViewTotalTamu AS
SELECT COUNT(*) AS TotalTamu
FROM Tamu;

-- 2. Total reservasi
CREATE VIEW ViewTotalReservasi AS
SELECT COUNT(*) AS TotalReservasi
FROM Reservasi;

-- 3. Total pendapatan
CREATE VIEW ViewTotalPendapatan AS
SELECT SUM(TotalBayar) AS TotalPendapatan
FROM Pembayaran;

-- 4. Rata-rata harga kamar
CREATE VIEW ViewRataHargaKamar AS
SELECT AVG(HargaPerMalam) AS RataHarga
FROM TipeKamar;

-- 5. Jumlah reservasi per status
CREATE VIEW ViewJumlahReservasiStatus AS
SELECT StatusReservasi, COUNT(*) AS Jumlah
FROM Reservasi
GROUP BY StatusReservasi;


-- 6. Reservasi + Tamu
CREATE VIEW ViewReservasiTamu AS
SELECT r.ReservasiID, t.NamaTamu, r.TanggalCheckIn, r.TanggalCheckOut
FROM Reservasi r
JOIN Tamu t ON r.TamuID = t.TamuID;

-- 7. Reservasi + Kamar
CREATE VIEW ViewReservasiKamar AS
SELECT r.ReservasiID, k.NomorKamar, tk.NamaTipe
FROM Reservasi r
JOIN DetailReservasi dr ON r.ReservasiID = dr.ReservasiID
JOIN Kamar k ON dr.KamarID = k.KamarID
JOIN TipeKamar tk ON k.TipeKamarID = tk.TipeKamarID;

-- 8. Pembayaran lengkap
CREATE VIEW ViewPembayaranLengkap AS
SELECT p.PembayaranID, t.NamaTamu, p.TotalBayar, m.NamaMetode
FROM Pembayaran p
JOIN Reservasi r ON p.ReservasiID = r.ReservasiID
JOIN Tamu t ON r.TamuID = t.TamuID
JOIN MetodePembayaran m ON p.MetodeID = m.MetodeID;

-- 9. Pegawai + Reservasi
CREATE VIEW ViewPegawaiReservasi AS
SELECT pg.NamaPegawai, r.ReservasiID, r.StatusReservasi
FROM Pegawai pg
JOIN Reservasi r ON pg.PegawaiID = r.PegawaiID;

-- 10. Layanan per reservasi
CREATE VIEW ViewLayananReservasi AS
SELECT r.ReservasiID, l.NamaLayanan, dl.Jumlah
FROM DetailLayanan dl
JOIN Reservasi r ON dl.ReservasiID = r.ReservasiID
JOIN Layanan l ON dl.LayananID = l.LayananID;



-- 11. Kamar tersedia
CREATE VIEW ViewKamarTersedia AS
SELECT * FROM Kamar
WHERE StatusKamar = 'Tersedia';

-- 12. Reservasi aktif
CREATE VIEW ViewReservasiAktif AS
SELECT * FROM Reservasi
WHERE StatusReservasi = 'Aktif';

-- 13. Pembayaran lunas
CREATE VIEW ViewPembayaranLunas AS
SELECT * FROM Pembayaran
WHERE StatusPembayaran = 'Lunas';

-- 14. Layanan murah
CREATE VIEW ViewLayananMurah AS
SELECT * FROM Layanan
WHERE HargaLayanan < 100000;

-- 15 setiap pegawai
CREATE VIEW View_DaftarPegawai
AS
SELECT 
    PegawaiID,
    NamaPegawai,
    Jabatan,
    NoTelepon
FROM Pegawai;
GO


-- 1. Tambah data tamu
CREATE PROCEDURE SpTambahTamu
@Nama VARCHAR(100),
@Alamat VARCHAR(255),
@NoTelp VARCHAR(20),
@Email VARCHAR(100)
AS
BEGIN
    INSERT INTO Tamu VALUES (@Nama, @Alamat, @NoTelp, @Email);
END;
GO

-- 2. Update status kamar
CREATE PROCEDURE SpUpdateStatusKamar
@KamarID INT,
@Status VARCHAR(20)
AS
BEGIN
    UPDATE Kamar
    SET StatusKamar = @Status
    WHERE KamarID = @KamarID;
END;
GO

-- 3. Total pembayaran per reservasi
CREATE PROCEDURE SpTotalPembayaran
@ReservasiID INT
AS
BEGIN
    SELECT SUM(TotalBayar) AS Total
    FROM Pembayaran
    WHERE ReservasiID = @ReservasiID;
END;
GO

-- Trigger 1: Kamar otomatis TERISI
CREATE TRIGGER TrgKamarTerisi
ON DetailReservasi
AFTER INSERT
AS
BEGIN
    UPDATE Kamar
    SET StatusKamar = 'Terisi'
    WHERE KamarID IN (SELECT KamarID FROM inserted);
END;
GO

-- Trigger 2: Reservasi SELESAI jika pembayaran LUNAS
CREATE TRIGGER TrgReservasiSelesai
ON Pembayaran
AFTER INSERT
AS
BEGIN
    UPDATE Reservasi
    SET StatusReservasi = 'Selesai'
    WHERE ReservasiID IN (
        SELECT ReservasiID FROM inserted
        WHERE StatusPembayaran = 'Lunas'
    );
END;
GO

-- Cek total tamu
SELECT * FROM ViewTotalTamu;

--Cek tipe kamar ada apa saja
SELECT * FROM TipeKamar;

-- Cek total reservasi
SELECT * FROM ViewTotalReservasi;

-- Cek total pendapatan hotel
SELECT * FROM ViewTotalPendapatan;

-- Cek rata-rata harga kamar
SELECT * FROM ViewRataHargaKamar;

-- Cek jumlah reservasi berdasarkan status
SELECT * FROM ViewJumlahReservasiStatus;

-- Cek reservasi beserta nama tamu
SELECT * FROM ViewReservasiTamu;

-- Cek reservasi beserta kamar dan tipe kamar
SELECT * FROM ViewReservasiKamar;

-- Cek pembayaran lengkap
SELECT * FROM ViewPembayaranLengkap;

-- Cek pegawai yang menangani reservasi
SELECT * FROM Reservasi;

--View ini digunakan untuk menampilkan data pegawai beserta reservasi yang mereka tangani dan status reservasinya.
SELECT * FROM ViewPegawaiReservasi

-- Cek layanan tambahan per reservasi
SELECT * FROM ViewLayananReservasi;

-- Cek kamar tersedia
SELECT * FROM ViewKamarTersedia;

-- Cek reservasi aktif
SELECT * FROM ViewReservasiAktif;

-- Cek pembayaran lunas
SELECT * FROM ViewPembayaranLunas;

-- Cek layanan murah
SELECT * FROM ViewLayananMurah;

-- Cek pegawai sesuai jabatan
SELECT * FROM Pegawai
ORDER BY Jabatan;

-- Cek metodepembayaran
SELECT * FROM MetodePembayaran;

-- Cek metodepembayaran
SELECT * FROM DetailLayanan;

-- Cek Detai Reservasi
SELECT * FROM DetailReservasi;

--Cek DetailPembayaran
SELECT * FROM Pembayaran;

-- Cek Kamar
SELECT * FROM Kamar;


-- Jalankan procedure
EXEC SpTambahTamu 
    'Candra', 
    'Banten', 
    '08234135171', 
    'candara12@mail.com';

-- Cek hasilnya
SELECT * FROM Tamu
ORDER BY TamuID DESC;

-- Cek status kamar sebelum
SELECT * FROM Kamar WHERE KamarID = 1;

-- Jalankan procedure
EXEC SpUpdateStatusKamar 1, 'Terisi';

-- Cek status kamar sesudah
SELECT * FROM Kamar WHERE KamarID = 1;

-- Hitung total pembayaran reservasi ID 1
EXEC SpTotalPembayaran 1;

-- Cek status kamar sebelum
SELECT * FROM Kamar WHERE KamarID = 2;

-- Insert detail reservasi (trigger aktif)
INSERT INTO DetailReservasi (ReservasiID, KamarID)
VALUES (2, 2);

-- Cek status kamar sesudah
SELECT * FROM Kamar WHERE KamarID = 2;

-- Cek status reservasi sebelum
SELECT * FROM Reservasi WHERE ReservasiID = 3;

-- Insert pembayaran LUNAS (trigger aktif)
INSERT INTO Pembayaran
(TanggalBayar, TotalBayar, StatusPembayaran, ReservasiID, MetodeID)
VALUES ('2025-02-01', 500000, 'Lunas', 3, 1);

-- Cek status reservasi sesudah
SELECT * FROM Reservasi WHERE ReservasiID = 3;

--Cek Triger 1
EXEC sp_helptext 'TrgKamarTerisi';

SELECT KamarID, NomorKamar, StatusKamar
FROM Kamar
WHERE KamarID = 1;

INSERT INTO DetailReservasi (ReservasiID, KamarID)
VALUES (1, 1);

SELECT KamarID, NomorKamar, StatusKamar
FROM Kamar
WHERE KamarID = 1;

--cek triger 2
EXEC sp_helptext 'TrgReservasiSelesai';
SELECT ReservasiID, StatusReservasi
FROM Reservasi
WHERE ReservasiID = 1;

